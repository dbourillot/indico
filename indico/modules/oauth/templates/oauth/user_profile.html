{% extends 'users/base.html' %}
{% from '_switch.html' import switch %}
{% from 'message_box.html' import message_box %}

{% block subtitle -%}
    {% trans %}Authorized applications{% endtrans %}
{%- endblock %}

{% block user_content %}
    {% if tokens %}
        <div class="i-box titled">
            <div class="i-box-header">
                <div class="i-box-title">
                    {%- trans %}Authorized applications{% endtrans -%}
                </div>
            </div>
            <div class="i-box-content">
                <p>{% trans %}This is the list of applications your authorized to access your Indico data.{% endtrans %}</p>
                <ul class="group-list with-buttons">
                    {% for token in tokens %}
                        <li>
                            <span class="list-item-title">{{ token.application.name }}</span>
                            <span class="right">
                                <span class="list-item-info">
                                    <span class="label">{% trans %}Last used:{% endtrans %}</span>
                                    <span class="content">
                                        {% if token.last_used_dt %}
                                            {{ token.last_used_dt | format_datetime('short') }}
                                        {% else %}
                                            {% trans %}Never{% endtrans %}
                                        {% endif %}
                                    </span>
                                </span>
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    {% call message_box('warning', id='no-third-apps', style=('display:none;' if tokens else '')) %}
        {%- trans %}No third party applications have been authorized.{% endtrans -%}
    {% endcall %}

    <script>
        $('#oauth-token-list').on('click', '.icon-remove', function() {
            var self = $(this);
            var killProgress = IndicoUI.Dialogs.Util.progress($T('Deleting...'));
            jsonRpc(Indico.Urls.JsonRpcService, 'oauth.unauthorizeConsumer', {
                third_party_app: self.data('third-party-app'),
                userId: '{{ user.id }}'
            }, function(result, error){
                killProgress();
                if (error) {
                    IndicoUtil.errorReport(error);
                    return
                }
                self.closest('li').remove();
                if (!$('#oauth-token-list').children().length) {
                    $('#oauth-token-list').hide();
                    $('#no-third-apps').show();
                }
            });
        });
    </script>
{% endblock %}
